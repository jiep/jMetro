name: CI

on:
  push:
    branches:
      - master
    tags:
      - v*
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write
      
    steps:
    - name: Install Maven
      run: sudo mkdir -p /usr/share/man/man1/ && sudo apt update && sudo apt install -y maven python3

    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    - name: Set up JDK 8
      uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
      with:
        distribution: 'zulu'
        java-version: '8'
    - name: Build with Maven
      run: mvn clean compile resources:resources assembly:single

    - name: Move jar to root
      if: startsWith(github.ref, 'refs/tags/v')
      run: mv target/jMetro-*-jar-with-dependencies.jar .

    - name: Set release
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        chmod +x ./.github/extract_version
        VERSION=`./.github/extract_version`

        set -x
        gh release create "v$VERSION" ./*.jar --title "v$VERSION" --notes "Release v$VERSION"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate attestation
      if: startsWith(github.ref, 'refs/tags/v')
      uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3.1.0
      with:
        subject-path: "jMetro-*.jar"
